<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Login • hCaptcha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <script src="https://hcaptcha.com/1/api.js" async defer></script>
  <style>
    :root{
      --bg: #0b0f1a;
      --card: rgba(255,255,255,.08);
      --card-border: rgba(255,255,255,.14);
      --text: #e6e8ee;
      --muted: #bac1d4;
      --primary: #7c5cff;
      --primary-700: #6746ff;
      --ring: rgba(124,92,255,.45);
      --error: #ff5470;
      --ok: #1ec28b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --card:#fff; --card-border:#e6e8f0; --text:#0b1220; --muted:#4c5465;
        --ring: rgba(124,92,255,.35); --shadow: 0 10px 30px rgba(21,23,35,.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background: radial-gradient(1200px 800px at 10% 10%, #1c1f2b 0, transparent 50%),
                         radial-gradient(1200px 800px at 90% 90%, #181d33 0, transparent 50%),
                         var(--bg);
      display:grid; place-items:center; padding:2rem;
    }
    .card{
      width:min(560px, 100%);
      border:1px solid var(--card-border);
      background:linear-gradient(180deg, color-mix(in oklab, var(--card), white 3%), var(--card));
      backdrop-filter: blur(10px);
      border-radius:20px; padding:1.5rem; box-shadow:var(--shadow);
      position:relative; overflow:hidden;
    }
    .glow{
      position:absolute; inset:-40% -10% auto auto; width:420px; height:420px; filter: blur(60px);
      background:conic-gradient(from 200deg, rgba(124,92,255,.25), rgba(30,194,139,.22), transparent 40%);
      pointer-events:none;
    }
    header{display:flex; align-items:center; gap:.75rem; margin-bottom:1rem}
    .logo{width:36px; height:36px; border-radius:10px; background:
      radial-gradient(closest-side, #fff 0 40%, transparent 41%),
      conic-gradient(var(--primary), #20d198, #00bcd4, var(--primary));
      box-shadow:0 6px 16px rgba(124,92,255,.35);
    }
    h1{font-size:1.35rem; margin:0}
    p.sub{margin:.15rem 0 0; color:var(--muted); font-size:.95rem}

    form{display:grid; gap:1rem; margin-top:.75rem}

    .field{display:grid; gap:.4rem}
    .label{font-weight:600; font-size:.92rem}
    .input{display:flex; align-items:center; gap:.55rem; border:1px solid var(--card-border); background:#0000; border-radius:12px; padding:.75rem .9rem; transition: .2s ease;
      outline: none; box-shadow:0 0 0 0 var(--ring)}
    .input:focus-within{border-color:color-mix(in oklab, var(--primary), #fff 12%); box-shadow:0 0 0 6px var(--ring)}
    .input input{all:unset; flex:1; min-width:0}
    .input button.icon{all:unset; cursor:pointer; border-radius:8px; padding:.35rem; display:grid; place-items:center}
    .input svg{width:18px; height:18px}

    .row{display:flex; gap:.75rem; align-items:center; justify-content:space-between; flex-wrap:wrap}

    .h-captcha{margin-top:.25rem}

    .btn{appearance:none; border:0; cursor:pointer; padding:.9rem 1rem; border-radius:12px; font-weight:700; letter-spacing:.2px;
      background:linear-gradient(180deg, var(--primary) 0%, var(--primary-700) 100%);
      color:white; box-shadow:0 10px 20px rgba(124,92,255,.35), inset 0 -2px 0 rgba(0,0,0,.2);
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6; cursor:not-allowed; filter:saturate(.6)}

    .btn-ghost{background:transparent; color:var(--text); border:1px solid var(--card-border); box-shadow:none; font-weight:600}
    .actions{display:flex; gap:.6rem; flex-wrap:wrap}

    .muted{color:var(--muted); font-size:.92rem}

    .alert{border-radius:12px; padding:.75rem .9rem; font-weight:600}
    .alert.ok{background: color-mix(in oklab, var(--ok), transparent 80%); border:1px solid color-mix(in oklab, var(--ok), #000 20%)}
    .alert.err{background: color-mix(in oklab, var(--error), transparent 85%); border:1px solid color-mix(in oklab, var(--error), #000 20%)}

    pre{background:color-mix(in oklab, var(--card), white 4%); border:1px dashed var(--card-border); padding:1rem; border-radius:12px; overflow:auto; margin:0}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

    footer{margin-top:.75rem}
  </style>
</head>
<body>
  <main class="card" aria-labelledby="title">
    <div class="glow"></div>
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 id="title">Bem-vindo de volta</h1>
        <p class="sub">Acesse sua conta com proteção por hCaptcha</p>
      </div>
    </header>

    <form id="form-login" novalidate>
      <div class="field">
        <label class="label" for="email">E-mail</label>
        <div class="input">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M4 8l8 5 8-5"/><rect x="3" y="5" width="18" height="14" rx="2"/></svg>
          <input id="email" name="email" type="email" placeholder="seu@email.com" autocomplete="email" required />
        </div>
      </div>

      <div class="field">
        <label class="label" for="password">Senha</label>
        <div class="input">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <input id="password" name="password" type="password" placeholder="••••••••" autocomplete="current-password" required />
          <button type="button" class="icon" id="toggle-pass" aria-label="Mostrar/ocultar senha">
            <svg id="eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
      </div>

      <div class="field">
        <div class="row">
          <span class="label">Verificação</span>
          <span class="muted">Protegido por hCaptcha</span>
        </div>
        <!-- Troque data-sitekey pelo seu sitekey real -->
        <div class="h-captcha" data-sitekey="5d3c4748-123c-4d98-a0be-6c9c00beb682"></div>
      </div>

      <div class="row">
        <button class="btn" id="btn-submit" type="submit">Entrar</button>
        <div class="actions">
          <button type="button" class="btn btn-ghost" id="btn-profile">/api/profile</button>
          <button type="button" class="btn btn-ghost" id="btn-logout">Sair</button>
        </div>
      </div>

      <div role="status" aria-live="polite" id="msg" class="muted"></div>
      <pre id="out" hidden></pre>
      
    </form>
  </main>

  <script>
    // ===== Helpers =====
    const $ = (s, el=document) => el.querySelector(s);
    const form = $('#form-login');
    const msg  = $('#msg');
    const out  = $('#out');
    const btnSubmit = $('#btn-submit');
    const btnProfile = $('#btn-profile');
    const btnLogout  = $('#btn-logout');
    const togglePass = $('#toggle-pass');

    const setMsg = (text, kind) => {
      msg.className = kind ? `alert ${kind}` : 'muted';
      msg.textContent = text || '';
    };
    const setOut = (obj) => {
      if (!obj){ out.hidden = true; out.textContent=''; return; }
      out.hidden = false; out.textContent = JSON.stringify(obj, null, 2);
    };
    const getToken = () => localStorage.getItem('jwt');

    // Show/hide password
    togglePass.addEventListener('click', () => {
      const input = $('#password');
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      $('#eye').innerHTML = isPwd
        ? '<path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a20.29 20.29 0 0 1 5.06-6.94M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a20.35 20.35 0 0 1-4.07 5.14M1 1l22 22M9.9 9.9A3 3 0 0 0 12 9c1.66 0 3 1.34 3 3a3 3 0 0 0-.9 2.1"/>'
        : '<path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3"/>';
    });

    // Submit handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMsg('Enviando login...');
      setOut();

      try{
        // Pega o token do hCaptcha via API oficial (se disponível)
        const tokenCaptcha = window.hcaptcha?.getResponse() || document.querySelector('textarea[name="h-captcha-response"]')?.value;
        if (!tokenCaptcha){ setMsg('Complete o hCaptcha.', 'err'); return; }

        if (!form.reportValidity?.() && form.checkValidity && !form.checkValidity()) return;

        btnSubmit.disabled = true;

        const formData = new FormData(form);
        formData.append('hCaptchaToken', tokenCaptcha);

        const res  = await fetch('/api/login', { method: 'POST', body: formData });
        const data = await res.json().catch(() => ({}));

        if (data.ok && data.token){
          localStorage.setItem('jwt', data.token);
          setMsg('✅ Logado com sucesso!', 'ok');
          setOut(data);
        } else {
          setMsg('❌ ' + (data.error || 'Falha no login.'), 'err');
          setOut(data);
        }
      }catch(err){
        console.error(err);
        setMsg('❌ Erro de rede.', 'err');
      }finally{
        btnSubmit.disabled = false;
        // Reseta o hCaptcha para um novo desafio
        try{ window.hcaptcha?.reset(); }catch{}
      }
    });

    // /api/profile demo
    btnProfile.addEventListener('click', async () => {
      setMsg('Chamando /api/profile...');
      setOut();
      const jwt = getToken();
      if (!jwt){ setMsg('Faça login primeiro.', 'err'); return; }
      try{
        const res  = await fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + jwt } });
        const data = await res.json().catch(() => ({}));
        setMsg(res.ok ? '✅ OK' : '❌ Erro', res.ok ? 'ok' : 'err');
        setOut(data);
      }catch(e){
        console.error(e);
        setMsg('❌ Erro de rede.', 'err');
      }
    });

    // logout
    btnLogout.addEventListener('click', () => {
      localStorage.removeItem('jwt');
      setMsg('Sessão encerrada.', 'ok');
      setOut();
    });
  </script>

  <!--
  🔒 Notas de segurança (servidor):
  - Valide o hCaptcha no backend usando o token (hCaptchaToken) e sua SECRET.
  - Rejeite logins sem verificação de captcha válida.
  - Considere usar cookie httpOnly + SameSite em vez de localStorage para JWT em produção.
  - Aplique rate limiting e bloqueio progressivo por IP/user/email.
  - Retorne mensagens de erro genéricas para evitar enumeração de usuários.
  - Habilite CORS/CSRF de acordo com sua arquitetura.
  -->
</body>
</html>